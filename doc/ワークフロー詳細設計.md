### **[暫定]ワークフロー詳細設計**
本設計では、**教材の自動生成・承認・配信・学習管理の一連の流れ**を明確にします。  
以下の各フローについて設計し、最後に **未決定の要件** をまとめました。

---

## **1. ワークフロー全体図**
```
(1) 教材アップロード → (2) OCR処理 → (3) 文法解析・スクリプト生成
→ (4) 教材の管理者チェック・修正 → (5) 教材の承認
→ (6) スライド・動画・クイズ生成 → (7) Moodleへ登録
→ (8) 学習者が教材閲覧 → (9) 確認テスト
→ (10) 学習進捗の記録・成績管理
```

---

## **2. 各ワークフロー詳細**

### **(1) 教材アップロード**
✅ **目的**: 1課分の教材（PDF）をシステムに取り込み、自動処理を開始  
✅ **トリガー**: **管理者がPDFをアップロード**  
✅ **処理内容**:
   - PDFを受け取り、OCR処理用のAPIに送信  
   - OCRが完了するまで **非同期処理で待機**  
✅ **エラー処理**:
   - PDFのアップロード失敗時 → **管理者に通知**
   - PDFがOCR不可能な場合 → **エラーメッセージを表示**
✅ **出力**:
   - OCR処理後のテキストデータ  
   - 次の **(2) OCR処理** へ進行

---

### **(2) OCR処理**
✅ **目的**: PDFからテキストデータを抽出  
✅ **トリガー**: **教材アップロード後、自動処理**  
✅ **処理内容**:
   - **OCRエンジン（Tesseract）** を用いてテキスト抽出  
   - ノイズ除去・フォーマット修正  
✅ **エラー処理**:
   - 文字認識の精度が低い場合 → **管理者に手動修正を促す**
✅ **出力**:
   - 正規化された日本語テキスト  
   - 次の **(3) 文法解析・スクリプト生成** へ進行

---

### **(3) 文法解析・スクリプト生成**
✅ **目的**: OCR結果をもとに、文法スクリプトとクイズを自動生成  
✅ **トリガー**: **OCR処理完了後、自動処理**  
✅ **処理内容**:
   - GPT-4 APIに **文法解析リクエストを送信**  
   - **文法解説・例文・スライド用テキストを生成**  
   - **クイズ（H5P用データ）を自動生成**  
✅ **エラー処理**:
   - GPT-4 APIからの応答が遅延した場合 → **再試行**
✅ **出力**:
   - 文法スクリプト  
   - クイズデータ（H5P形式）  
   - 次の **(4) 教材の管理者チェック・修正** へ進行

---

### **(4) 教材の管理者チェック・修正**
✅ **目的**: 自動生成された教材を **管理者が確認・修正** する  
✅ **トリガー**: **文法スクリプト・クイズ生成完了後、管理者が手動確認**  
✅ **処理内容**:
   - システムが管理者に **「教材の確認依頼」通知を送信**  
   - **管理画面で文法スクリプトとクイズを表示**  
   - **管理者が修正・承認**（GPTの出力ミスを修正）  
✅ **エラー処理**:
   - 教材が不適切な場合 → **修正して再送信**
✅ **出力**:
   - **管理者承認済みの教材データ**
   - 次の **(5) 教材の承認** へ進行

---

### **(5) 教材の承認**
✅ **目的**: 教材の修正が完了したら **管理者が正式承認** し、教材生成をトリガーする  
✅ **トリガー**: **管理者が「教材承認」ボタンをクリック**  
✅ **処理内容**:
   - **承認データをデータベースに記録**
   - **スライド・動画・クイズ生成の自動処理を開始**
✅ **エラー処理**:
   - 教材が未承認のままの場合 → **通知を自動再送**
✅ **出力**:
   - 教材が承認済み  
   - **スライド・動画・クイズ生成がスタート**

---

### **(6) スライド・動画・クイズ生成**
✅ **目的**: 教材承認後、スライド・動画・クイズを自動生成  
✅ **トリガー**: **承認完了後、自動処理**  
✅ **処理内容**:
   - **Google Slides API** でスライドを作成  
   - **HeyGen API** でアバター動画を作成  
   - **H5P API** でクイズをMoodleに登録  
✅ **エラー処理**:
   - APIリクエスト失敗時 → **リトライ処理を実装**
✅ **出力**:
   - **教材が完成**
   - 次の **(7) Moodleへ登録** へ進行

---

### **(7) Moodleへ登録**
✅ **目的**: 生成された教材をMoodleに登録  
✅ **トリガー**: **スライド・動画・クイズの生成完了後、自動処理**  
✅ **処理内容**:
   - **Moodle API** を利用し、教材をコースに追加  
✅ **エラー処理**:
   - Moodle登録失敗時 → **再送信 or 管理者通知**
✅ **出力**:
   - **学習者が教材を閲覧できる状態**
   - 次の **(8) 学習者の学習** へ進行

---

### **(8) 学習者の学習**
✅ **目的**: 学習者が教材を閲覧し、クイズに取り組む  
✅ **トリガー**: **学習者がMoodleにログイン**  
✅ **処理内容**:
   - 教材（スライド・動画・クイズ）を順番に学習  
   - **最後に確認テストを実施**
✅ **出力**:
   - 学習完了 or 次の課へ進行

---

## **3. 未決定の要件（確認が必要）**
✅ **1. 管理者が修正後に「再チェック」が必要か？**
   - **承認前に再レビューが必要か、それとも修正後は即承認か？**

✅ **2. 教材が未承認の場合の通知フロー**
   - **管理者が一定期間内に承認しない場合、自動リマインドが必要か？**

✅ **3. 学習者の進捗管理の方式**
   - **進捗の記録方法：クイズ完了時に記録 or 学習時間ベース？**

✅ **4. 確認テストの合格基準**
   - **現状 80%合格基準だが、変更する可能性があるか？**
   - **何回まで受験可能にするか？**

---

### **🚀 次のステップ**
✅ **未決定の要件について確認し、確定する**  
✅ **決定後、ワークフローを最終化**  
✅ **設計書に反映して、開発へ進む**

この内容で問題ないか、ご確認ください！  
**追加すべき項目や修正点があれば教えてください！**
